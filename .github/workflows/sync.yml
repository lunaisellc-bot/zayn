name: Sync Etsy -> Zayn Website

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1) Etsy access token al (refresh token ile)
      - name: Get Etsy access token
        id: token
        env:
          CLIENT_ID: ${{ secrets.ETSY_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.ETSY_CLIENT_SECRET }}
          REFRESH_TOKEN: ${{ secrets.ETSY_REFRESH_TOKEN }}
        run: |
          set -euo pipefail
          resp="$(curl -sS -X POST 'https://api.etsy.com/v3/public/oauth/token' \
            -H 'Content-Type: application/x-www-form-urlencoded' \
            -d "grant_type=refresh_token&client_id=${CLIENT_ID}&client_secret=${CLIENT_SECRET}&refresh_token=${REFRESH_TOKEN}")"
          # access_token var mı kontrol et
          echo "$resp" | jq -e .access_token >/dev/null
          echo "access_token=$(echo "$resp" | jq -r .access_token)" >> "$GITHUB_OUTPUT"

      # 2) Aktif ilanları + kapak görsellerini çek ve products.json yaz
      - name: Build products.json (with images)
        env:
          CLIENT_ID: ${{ secrets.ETSY_CLIENT_ID }}
          SHOP_ID: ${{ secrets.ETSY_SHOP_ID }}
          ACCESS_TOKEN: ${{ steps.token.outputs.access_token }}
        run: |
          set -euo pipefail
          python3 - << 'PY'
          import json, os, urllib.request
          from urllib.error import HTTPError, URLError

          ACCESS_TOKEN = os.environ["ACCESS_TOKEN"].strip()
          CLIENT_ID   = os.environ["CLIENT_ID"].strip()
          SHOP_ID     = os.environ["SHOP_ID"].strip()

          def req(url: str):
              return urllib.request.Request(
                  url,
                  headers={
                      "x-api-key": CLIENT_ID,
                      "Authorization": f"Bearer {ACCESS_TOKEN}",
                  },
              )

          def get_json(url: str):
              try:
                  with urllib.request.urlopen(req(url), timeout=30) as r:
                      return json.load(r)
              except HTTPError as e:
                  body = e.read().decode("utf-8", "ignore")
                  print("HTTPError", e.code, url)
                  print("RESPONSE BODY >>", body)
                  raise
              except URLError as e:
                  print("URLError", url, e)
                  raise

          # Sanity: token gerçekten geçerli mi?
          _ = get_json("https://api.etsy.com/v3/application/users/me")

          # Aktif ilanları 100'erli sayfalama ile çek
          items, offset = [], 0
          while True:
              data = get_json(f"https://api.etsy.com/v3/application/shops/{SHOP_ID}/listings/active?limit=100&offset={offset}")
              chunk = data.get("results") or []
              if not chunk:
                  break
              items.extend(chunk)
              if len(chunk) < 100:
                  break
              offset += 100

          # Her ilan için bir kapak görseli iste
          out = []
          for it in items:
              lid = it.get("listing_id") or it.get("id")
              title = (it.get("title") or "").strip()
              if not lid:
                  continue

              image = None
              try:
                  imgs = get_json(f"https://api.etsy.com/v3/application/listings/{lid}/images").get("results") or []
                  if imgs:
                      rec = imgs[0]
                      image = rec.get("url_fullxfull") or rec.get("url_570xN") or rec.get("url_170x135")
              except Exception:
                  # Hata gövdesi yukarıda loglandı, sessizce geç
                  pass

              out.append({
                  "id": lid,
                  "title": title,
                  "href": f"https://www.etsy.com/listing/{lid}",
                  "image": image
              })

          with open("products.json", "w", encoding="utf-8") as f:
              json.dump(out, f, ensure_ascii=False, indent=2)

          print(f"Wrote {len(out)} items to products.json")
          PY

      # 3) Değişiklik varsa commit & push
      - name: Commit updated data
        run: |
          set -euo pipefail
          if git status --porcelain | grep -q 'products.json'; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add products.json
            git commit -m "sync: update products.json from Etsy"
            git push
          else
            echo "No changes to commit."
          fi